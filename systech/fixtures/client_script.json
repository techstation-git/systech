[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Receipt",
  "enabled": 1,
  "modified": "2026-01-01 10:57:20.520366",
  "module": "Systech",
  "name": "Purchase Receipt",
  "script": "/* Purchase Receipt Security Script */\n/* Hides prices in FORM and LIST VIEW for Warehouse Keeper */\n\n// 1. Helper function\nfunction is_warehouse_keeper_only() {\n    const excluded_roles = [\"System Manager\", \"Accounts Manager\", \"Purchase Manager\"];\n    return frappe.user.has_role(\"Warehouse Keeper\") \n        && !frappe.user_roles.some(r => excluded_roles.includes(r));\n}\n\n// 2. Form Logic (unchanged from before)\nfunction hide_prices_for_warehouse_keeper(frm) {\n    if (!is_warehouse_keeper_only()) return;\n    \n    const hidden_fields = [\n        'base_discount_amount', 'base_grand_total', 'base_net_total',\n        'base_total', 'base_total_taxes_and_charges', 'discount_amount',\n        'grand_total', 'net_total', 'total', 'total_taxes_and_charges',\n        'taxes', 'buying_price_list', 'price_list_currency',\n        'plc_conversion_rate', 'currency', 'conversion_rate',\n        'total_qty', 'total_net_weight', 'rounding_adjustment',\n        'rounded_total', 'in_words',\n        'rate', 'amount', 'base_rate', 'base_amount',\n        'net_rate', 'net_amount', 'valuation_rate',\n        'price_list_rate', 'discount_percentage',\n        'rm_supp_cost', 'landed_cost_voucher_amount',\n        'margin_type', 'margin_rate_or_amount',\n        'rate_with_margin', 'billed_amt',\n        'amount_difference_with_purchase_invoice'\n    ];\n\n    hidden_fields.forEach(f => frm.set_df_property(f, 'hidden', 1));\n\n    const selectors = hidden_fields.map(f => `\n        div[data-fieldname=\"${f}\"],\n        .form-group[data-fieldname=\"${f}\"],\n        .grid-row-cell[data-fieldname=\"${f}\"],\n        .grid-static-col[data-fieldname=\"${f}\"],\n        .grid-heading-row [data-fieldname=\"${f}\"],\n        .grid-row-open [data-fieldname=\"${f}\"],\n        .slide-sheet [data-fieldname=\"${f}\"],\n        td[data-fieldname=\"${f}\"],\n        th[data-fieldname=\"${f}\"],\n        .grid-body [data-fieldname=\"${f}\"],\n        .grid-footer [data-fieldname=\"${f}\"],\n        .ellipsis[data-fieldname=\"${f}\"],\n        span[data-fieldname=\"${f}\"]\n    `);\n    \n    // Also explicitly force hide list view cells if they have fieldname attributes (v15+)\n    selectors.push(`.list-row-col[data-fieldname=\"grand_total\"]`);\n    selectors.push(`.list-subject .level-item[data-fieldname=\"grand_total\"]`);\n\n    const css = selectors.join(\",\") + ` { display: none !important; visibility: hidden !important; } `;\n    const style_id = 'warehouse-keeper-security';\n    $(`#${style_id}`).remove();\n    $('<style>').attr('id', style_id).prop('type', 'text/css').html(css).appendTo('head');\n}\n\nfrappe.ui.form.on('Purchase Receipt', {\n    setup: function(frm) { hide_prices_for_warehouse_keeper(frm); },\n    onload: function(frm) { hide_prices_for_warehouse_keeper(frm); },\n    refresh: function(frm) { hide_prices_for_warehouse_keeper(frm); },\n    validate: function(frm) { hide_prices_for_warehouse_keeper(frm); }\n});\n\n// 3. List View Logic - AGGRESSIVE HIDING\nfrappe.listview_settings['Purchase Receipt'] = {\n    onload: function(listview) {\n        if (is_warehouse_keeper_only()) {\n            // Remove \"Grand Total\" from the internal columns list so it doesn't render\n            listview.settings.add_fields = listview.settings.add_fields || [];\n            // We can't easily remove fields once fetched, but we can hide the column by index\n        }\n    },\n    refresh: function(listview) {\n        if (is_warehouse_keeper_only()) {\n             // Method A: Hide by Column Header Text (Most reliable for \"Grand Total\")\n             // Find the index of the column \"Grand Total\"\n             \n             // Hide Header\n             $('.list-row-head .list-col').each(function(index) {\n                 if ($(this).text().trim() === \"Grand Total\") {\n                     // Hide this header\n                     $(this).css('display', 'none');\n                     // Hide all corresponding data cells\n                     $(`.list-row .list-col:nth-child(${index + 1})`).css('display', 'none');\n                 }\n             });\n             \n             // Method B: CSS Hammer (Backup)\n             // Hides usually the 4th/5th column or right-aligned currency columns\n             const css = `\n                /* Hide any column with \"Grand Total\" title attribute */\n                .list-col[title=\"Grand Total\"] { display: none !important; }\n                \n                /* Hide 4th column specifically (based on your screenshot) */\n                /* Adjust nth-child number if it hides the wrong thing! */\n                /* .list-row .list-col:nth-child(5), .list-row-head .list-col:nth-child(5) { display: none !important; } */\n             `;\n              $('<style>').prop('type', 'text/css').html(css).appendTo('head');\n        }\n    }\n};",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Stock Entry",
  "enabled": 1,
  "modified": "2026-01-06 20:29:40.871355",
  "module": "Systech",
  "name": "Stock Entry",
  "script": "/* Stock Entry Security */\nfrappe.ui.form.on('Stock Entry', {\n    refresh: function(frm) {\n\n        // Only hide for Warehouse Keeper, NOT Admin\n        if (frappe.user.has_role(\"Warehouse Keeper\") && !frappe.user.has_role(\"Administrator\")) {\n\n            // Main Fields\n            ['total_amount', 'total_additional_costs', 'total_outgoing_value', \n             'total_incoming_value', 'value_difference', 'difference_amount']\n            .forEach(f => frm.set_df_property(f, 'hidden', 1));\n\n            // Grid Columns\n            if(frm.fields_dict['items'] && frm.fields_dict['items'].grid) {\n                const grid = frm.fields_dict['items'].grid;\n                ['basic_rate', 'basic_amount', 'amount', 'valuation_rate', 'additional_cost']\n                .forEach(f => {\n                    grid.update_docfield_property(f, 'hidden', 1);\n                    grid.update_docfield_property(f, 'print_hide', 1);\n                    \n                    // Only hide in current grid rows, scoped properly\n                    grid.wrapper.find(`.grid-row [data-fieldname=\"${f}\"]`).hide();\n                });\n                grid.refresh();\n            }\n        }\n    }\n});\n\n// Child Form View\nfrappe.ui.form.on('Stock Entry Detail', {\n    form_render: function(frm, cdt, cdn) {\n\n        // Only hide for Warehouse Keeper, NOT Admin\n        if (frappe.user.has_role(\"Warehouse Keeper\") && !frappe.user.has_role(\"Administrator\")) {\n            const fields = ['basic_rate', 'basic_amount', 'amount', 'valuation_rate', 'additional_cost'];\n\n            // Get the child doc row wrapper\n            const row = frappe.get_doc(cdt, cdn);\n            fields.forEach(f => {\n                const $el = frm.fields_dict['items'].grid.get_row(cdn).$row.find(`[data-fieldname=\"${f}\"]`);\n                $el.hide();\n            });\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Item",
  "enabled": 1,
  "modified": "2025-12-31 13:02:21.108564",
  "module": "Systech",
  "name": "Item",
  "script": "/* Item Security */\nfrappe.ui.form.on('Item', {\n    refresh: function(frm) {\n        if (frappe.user.has_role(\"Warehouse Keeper\")) {\n            ['valuation_rate', 'standard_rate', 'last_purchase_rate', 'opening_stock_value']\n            .forEach(f => frm.set_df_property(f, 'hidden', 1));\n        }\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Delivery Note",
  "enabled": 1,
  "modified": "2026-01-01 11:25:12.261694",
  "module": "Systech",
  "name": "Delivery Note",
  "script": "/* Delivery Note Security Script */\n/* Hides price fields for Warehouse Keeper */\n\n// Helper to check role\nfunction is_warehouse_keeper_only() {\n    const excluded_roles = [\"System Manager\", \"Accounts Manager\", \"Sales Manager\"];\n    return frappe.user.has_role(\"Warehouse Keeper\") \n        && !frappe.user_roles.some(r => excluded_roles.includes(r));\n}\n\nfunction hide_prices_dn(frm) {\n    if (!is_warehouse_keeper_only()) return;\n\n    const hidden_fields = [\n        // Main Totals\n        'base_grand_total', 'base_net_total', 'base_total_taxes_and_charges',\n        'grand_total', 'net_total', 'total_taxes_and_charges', 'taxes',\n        'discount_amount', 'rounding_adjustment', 'rounded_total', 'in_words',\n        'currency', 'conversion_rate', 'price_list_currency', 'plc_conversion_rate',\n        'selling_price_list', 'total_commission', 'margin_type', 'base_total',\n\n        // Child Table (Delivery Note Item)\n        'rate', 'amount', 'base_rate', 'base_amount', \n        'net_rate', 'net_amount', 'base_net_rate', 'base_net_amount',\n        'price_list_rate', 'discount_percentage', 'discount_amount',\n        'margin_rate_or_amount', 'rate_with_margin', 'gross_profit',\n        'incoming_rate', 'outgoing_rate' // Valuation fields if visible\n    ];\n\n    // 1. Standard Hide\n    hidden_fields.forEach(f => {\n        frm.set_df_property(f, 'hidden', 1);\n    });\n\n    // 2. CSS Hide (Grid & Dialogs)\n    const selectors = hidden_fields.map(f => `\n        div[data-fieldname=\"${f}\"],\n        .form-group[data-fieldname=\"${f}\"],\n        .grid-row-cell[data-fieldname=\"${f}\"],\n        .grid-static-col[data-fieldname=\"${f}\"],\n        .grid-heading-row [data-fieldname=\"${f}\"],\n        .grid-row-open [data-fieldname=\"${f}\"], \n        .slide-sheet [data-fieldname=\"${f}\"],\n        td[data-fieldname=\"${f}\"],\n        th[data-fieldname=\"${f}\"],\n        .grid-body [data-fieldname=\"${f}\"],\n        .grid-footer [data-fieldname=\"${f}\"]\n    `);\n\n    const css = selectors.join(\", \") + \" { display: none !important; }\";\n    \n    const style_id = 'pro-dn-security';\n    $(`#${style_id}`).remove();\n    $('<style>').attr('id', style_id).prop('type', 'text/css').html(css).appendTo('head');\n}\n\nfrappe.ui.form.on('Delivery Note', {\n    setup: function(frm) { hide_prices_dn(frm); },\n    onload: function(frm) { hide_prices_dn(frm); },\n    refresh: function(frm) { hide_prices_dn(frm); },\n    validate: function(frm) { hide_prices_dn(frm); }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 0,
  "modified": "2026-01-21 14:30:48.989540",
  "module": "Systech",
  "name": "Sales Order",
  "script": "frappe.ui.form.on('Sales Order', {\n    refresh(frm) {\n        // Unreserve Stock Button implementation\n        if (frm.doc.workflow_state === 'Locked' && frappe.user.has_role('Sales Manager')) {\n            if (frm.doc.status !== 'Closed') {\n                frm.add_custom_button(__('Unreserve Stock'), function() {\n                     frappe.confirm(\n                        __('Are you sure you want to close this Sales Order and unreserve the stock?'),\n                        function() {\n                            frappe.call({\n                                method: 'systech.services.rest.unreserve_stock',\n                                args: {\n                                    sales_order_name: frm.doc.name\n                                },\n                                freeze: true,\n                                callback: function(r) {\n                                    if (!r.exc) {\n                                        frm.reload_doc();\n                                    }\n                                }\n                            });\n                        }\n                    );\n                }).addClass('btn-danger');\n            }\n        }\n\n        // 1. Hide standard buttons as before\n        if (frm.doc.docstatus === 1 && frm.doc.workflow_state !== \"Locked\") {\n            setTimeout(() => {\n                const to_hide = [\n                    ['Pick List', 'Create'], ['Delivery Note', 'Create'],\n                    ['Work Order', 'Create'], ['Sales Invoice', 'Create'],\n                    ['Material Request', 'Create'], ['Purchase Order', 'Create'],\n                    ['Request for Raw Materials', 'Create'], ['Project', 'Create'],\n                    ['Payment Request', 'Create'], ['Payment', 'Create'],\n                    ['Update Items', null], ['Hold', 'Status'],\n                    ['Close', 'Status'], ['Quotation', 'Get Items From']\n                ];\n                to_hide.forEach(b => frm.remove_custom_button(b[0], b[1]));\n            }, 10);\n        }\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Person",
  "enabled": 1,
  "modified": "2026-01-18 10:00:00",
  "module": "Systech",
  "name": "Sales Person",
  "script": "frappe.ui.form.on('Sales Person', {\n    refresh: function(frm) {\n         if (!frm.doc.__islocal) {\n             // 1. Hide Target Details for standard Sales Users\n             if (frappe.user.has_role('Sales User') && \n                !frappe.user.has_role('Sales Manager') && \n                !frappe.user.has_role('System Manager') &&\n                !frappe.user.has_role('Administrator')) {\n                 \n                 frm.set_df_property('target_details_section_break', 'hidden', 1);\n                 frm.set_df_property('targets', 'hidden', 1);\n             }\n             \n             // 2. Add Refresh Button\n             frm.add_custom_button(__('Refresh Stats'), function() {\n                 load_sales_stats(frm);\n             }).addClass('btn-primary');\n             \n             // 3. Initial Load\n             load_sales_stats(frm);\n         }\n    }\n});\n\nfunction load_sales_stats(frm) {\n    frm.set_value('target_status', 'Calculating...');\n    \n    frappe.call({\n        method: 'systech.services.api.get_salesperson_stats',\n        args: {\n            salesperson: frm.doc.name,\n            start_date: frappe.datetime.month_start(),\n            end_date: frappe.datetime.month_end()\n        },\n        no_cache: true,\n        callback: function(r) {\n            if (r.message) {\n                const stats = r.message;\n                frm.set_value('current_month_sales', stats.total_sales);\n                frm.set_value('current_month_qty', stats.total_items);\n                \n                let is_target_met = false;\n                let target_amt = stats.sales_target || 0;\n                let target_qty = stats.target_qty || 0;\n\n                if (target_amt > 0 && target_qty > 0) {\n                     if (stats.total_sales >= target_amt && stats.total_items >= target_qty) is_target_met = true;\n                } else if (target_amt > 0) {\n                     if (stats.total_sales >= target_amt) is_target_met = true;\n                } else if (target_qty > 0) {\n                     if (stats.total_items >= target_qty) is_target_met = true;\n                }\n\n                let base_rate = frm.doc.commission_rate || 0;\n                let incentive_rate = frm.doc.incentive_rate || 0;\n                \n                let status = \"\";\n                let base_comm = (stats.total_sales * base_rate) / 100;\n                let bonus_comm = 0;\n                \n                if (is_target_met) {\n                    bonus_comm = (stats.total_sales * incentive_rate) / 100;\n                    status = (incentive_rate > 0) ? `ðŸ”¥ Target Met! Earning ${base_rate}% + ${incentive_rate}% Incentive` : `Target Met! (Earning ${base_rate}% Commission)`;\n                } else {\n                    status = `Below Target (Standard: ${base_rate}%)`;\n                    if (target_amt > 0) {\n                        let remaining = target_amt - stats.total_sales;\n                        if (remaining > 0) {\n                            status += ` - Need ${format_currency(remaining, stats.currency)} more`;\n                        }\n                    }\n                }\n                \n                frm.set_value('target_status', status);\n                const total_comm = base_comm + bonus_comm;\n                frm.set_value('estimated_commission', total_comm);\n                \n                // Visual feedback in the description\n                let breakdown = `Standard (${base_rate}%): ${format_currency(base_comm, stats.currency)}`;\n                if (bonus_comm > 0) {\n                    breakdown += ` + Incentive (${incentive_rate}%): ${format_currency(bonus_comm, stats.currency)}`;\n                }\n                breakdown += ` = Total: ${format_currency(total_comm, stats.currency)}`;\n                \n                frm.set_df_property('target_status', 'description', breakdown);\n            }\n        }\n    });\n}",
  "view": "Form"
 }
]